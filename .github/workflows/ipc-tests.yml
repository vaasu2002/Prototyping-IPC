name: IPC Queue Tests

# Trigger on pushes to main and on pull requests
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run IPC Connection & Crash Recovery Tests
    runs-on: ubuntu-latest
    
    steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Install dependencies
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake g++
    
    # Create build directory
    - name: Create build directory
      run: mkdir -p build
    
    # Configure with CMake
    - name: Configure CMake
      run: |
        cd build
        cmake ..
    
    # Build the test executable
    - name: Build test executable
      run: |
        cd build
        make test_ipc_crash
    
    # Run the tests
    - name: Run IPC crash recovery tests
      run: |
        cd build
        ./test_ipc_crash
    
    # Optional: Build other executables to ensure nothing broke
    - name: Build all executables
      run: |
        cd build
        make process1
        make process2
    
    # Clean up shared memory and lock files after tests
    - name: Cleanup test artifacts
      if: always()
      run: |
        sudo rm -f /dev/shm/test_queue_* || true
        sudo rm -f /tmp/test_queue_*.lock || true
        sudo rm -f /tmp/test_queue_*.uuid || true